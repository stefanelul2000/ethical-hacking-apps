name: Security Pipeline

on:
  push:
    branches: ["ci"]

jobs:
  gitleaks:
    name: Secret Detection (Gitleaks)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: gitleaks/gitleaks-action@v2
        with:
          config-path: ""
          fail: true
  trivy:
    name: SAST + Dependency Scan (Trivy)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Trivy
        run: |
          sudo apt-get update
          sudo apt-get install -y wget
          wget -qO- https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo deb https://aquasecurity.github.io/trivy-repo/deb / | sudo tee /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install -y trivy

      - name: File System Scan
        run: trivy fs --exit-code 1 --severity HIGH,CRITICAL . | tee trivy-fs-report.txt

      - name: Vulnerability DB Scan
        run: trivy sbom --exit-code 1 --severity HIGH,CRITICAL . | tee trivy-sbom-report.txt

      - name: Summarize Trivy findings
        if: always()
        run: |
          echo "## Trivy File System Scan" >> $GITHUB_STEP_SUMMARY
          if [ -f trivy-fs-report.txt ]; then
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat trivy-fs-report.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "No file system scan report found." >> $GITHUB_STEP_SUMMARY
          fi
          echo "\n## Trivy SBOM Scan" >> $GITHUB_STEP_SUMMARY
          if [ -f trivy-sbom-report.txt ]; then
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat trivy-sbom-report.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "No SBOM scan report found." >> $GITHUB_STEP_SUMMARY
          fi

  bandit:
    name: Python Static Security Scan (Bandit)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Bandit & jq
        run: |
          python3 -m pip install bandit
          sudo apt-get update && sudo apt-get install -y jq

      # Run bandit but never fail the step (|| true)
      - name: Run Bandit in JSON mode
        run: |
          bandit -r . -f json -o bandit-report.json || true

      # Convert JSON to Markdown table
      - name: Output Findings
        if: always()
        run: |
          echo "## Bandit Security Findings" >> $GITHUB_STEP_SUMMARY
          if [ ! -f bandit-report.json ]; then
            echo "Bandit report missing! Failing." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          issues=$(jq '.results | length' bandit-report.json)

          if [ "$issues" -eq 0 ]; then
            echo "No issues found." >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          echo "| Severity | Confidence | Rule | Description | File | Line |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|------------|------|-------------|------|------|" >> $GITHUB_STEP_SUMMARY

          jq -r '
            .results[] |
            "| \(.issue_severity) | \(.issue_confidence) | **\(.test_id)** | \(.issue_text) | \(.filename) | \(.line_number) |"
          ' bandit-report.json >> $GITHUB_STEP_SUMMARY

  cppcheck:
    name: C/C++ Static Security Scan (cppcheck)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install cppcheck
        run: sudo apt-get update && sudo apt-get install -y cppcheck

      - name: Run cppcheck
        run: |
          cppcheck --enable=all --inconclusive --template='{file}:{line}:{severity}:{id}:{message}' . 2> cppcheck-report.txt || true

      - name: Summarize cppcheck findings
        if: always()
        run: |
          echo "## cppcheck Security Findings" >> $GITHUB_STEP_SUMMARY
          if [ ! -f cppcheck-report.txt ]; then
            echo "Report missing." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          if [ ! -s cppcheck-report.txt ]; then
            echo "No issues reported." >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

            echo "| File | Line | Severity | ID | Message |" >> $GITHUB_STEP_SUMMARY
            echo "|------|------|----------|----|---------|" >> $GITHUB_STEP_SUMMARY
            awk -F ':' '{printf "| %s | %s | %s | %s | %s |\n", $1, $2, $3, $4, substr($0, index($0, $5))}' cppcheck-report.txt >> $GITHUB_STEP_SUMMARY




