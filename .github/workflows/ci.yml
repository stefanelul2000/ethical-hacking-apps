name: Security Scan Pipeline

on:
  push:
    branches: ["*"]

jobs:
  gitleaks:
    name: Secret Detection (gitleaks)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: gitleaks/gitleaks-action@v2
        with:
          config-path: ""
          fail: true

  semgrep:
    name: Code Pattern Scan (semgrep)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Semgrep
        run: python3 -m pip install semgrep
      - name: Run Semgrep (OWASP Top 10)
        run: semgrep --config owasp-top-ten --json > semgrep-report.json || true
      - name: Summarize Semgrep findings
        if: always()
        run: |
          echo "## Semgrep OWASP Top 10 Findings" >> $GITHUB_STEP_SUMMARY
          if [ ! -f semgrep-report.json ]; then
            echo "Semgrep report missing!" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          issues=$(jq '.results | length' semgrep-report.json)
          if [ "$issues" -eq 0 ]; then
            echo "No issues found." >> $GITHUB_STEP_SUMMARY
            exit 0
          fi
          echo "| Severity | Check ID | Message | File | Line |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|----------|---------|------|------|" >> $GITHUB_STEP_SUMMARY
          jq -r '
            .results[] |
            "| " + (.extra.severity // "N/A") + " | " + (.check_id // "N/A") + " | " + (.extra.message // .check_id) + " | " + (.path // "N/A") + " | " + (.start.line // "N/A") + " |"
          ' semgrep-report.json >> $GITHUB_STEP_SUMMARY

  pylint:
    name: Python Static Analysis (pylint)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install pylint
        run: python3 -m pip install pylint
      - name: Run pylint
        run: pylint **/*.py > pylint-report.txt || true
      - name: Summarize pylint findings
        if: always()
        run: |
          echo "## pylint Report" >> $GITHUB_STEP_SUMMARY
          if [ -f pylint-report.txt ] && [ -s pylint-report.txt ]; then
            echo "| Type | File | Line | Message |" >> $GITHUB_STEP_SUMMARY
            echo "|------|------|------|---------|" >> $GITHUB_STEP_SUMMARY
            awk -F ':' 'match($0, /^([^:]+):([0-9]+):([0-9]+): ([A-Z][0-9]+[A-Z]?): (.+)/, arr) {
              printf "| %s | %s | %s | %s |\n", arr[4], arr[1], arr[2], arr[5]
            }' pylint-report.txt >> $GITHUB_STEP_SUMMARY
            tail -n 1 pylint-report.txt >> $GITHUB_STEP_SUMMARY
          else
            echo "No pylint issues found." >> $GITHUB_STEP_SUMMARY
          fi

  bandit:
    name: Python Security Scan (bandit)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install bandit
        run: python3 -m pip install bandit
      - name: Run Bandit in JSON mode
        run: bandit -r . -f json -o bandit-report.json || true
      - name: Summarize bandit findings
        if: always()
        run: |
          echo "## Bandit Security Scan" >> $GITHUB_STEP_SUMMARY
          echo "| Test ID | Severity | Description | File | Line |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|---------|-------------|------|------|" >> $GITHUB_STEP_SUMMARY
          if [ -f bandit-report.json ]; then
            jq -r '
              .results[] |
              "| " + .test_id + " | " + .issue_severity + " | " + .issue_text +
              " | " + .filename + " | " + (.line_number|tostring) + " |"
            ' bandit-report.json >> $GITHUB_STEP_SUMMARY
          else
            echo "No bandit issues found." >> $GITHUB_STEP_SUMMARY
          fi

  flake8:
    name: Python Code Quality (flake8)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install flake8
        run: python3 -m pip install flake8
      - name: Run flake8
        run: flake8 . --format=default --count --show-source --statistics > flake8-report.txt || true
      - name: Summarize flake8 findings
        if: always()
        run: |
          echo "## flake8 Code Quality" >> $GITHUB_STEP_SUMMARY
          echo "| Code | Description | File | Line |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------------|------|------|" >> $GITHUB_STEP_SUMMARY
          if [ -f flake8-report.txt ] && [ -s flake8-report.txt ]; then
            awk 'match($0, /^(.+?):([0-9]+):([0-9]+): ([A-Z][0-9]+) (.+)/, arr) {
                  printf "| %s | %s | %s | %s |\n", arr[4], arr[5], arr[1], arr[2]
                }' flake8-report.txt >> $GITHUB_STEP_SUMMARY
          else
            echo "No flake8 issues found." >> $GITHUB_STEP_SUMMARY
          fi

  clang-tidy:
    name: C/C++ Static Analysis (clang-tidy)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install clang-tidy
        run: sudo apt-get update && sudo apt-get install -y clang-tidy
      - name: Run clang-tidy
        run: |
          find . -name '*.cpp' | xargs clang-tidy > clang-tidy-report.txt || true
      - name: Summarize clang-tidy findings
        if: always()
        run: |
          echo "## clang-tidy Report" >> $GITHUB_STEP_SUMMARY
          if [ -f clang-tidy-report.txt ] && [ -s clang-tidy-report.txt ]; then
            echo "| File | Line | Severity | Message |" >> $GITHUB_STEP_SUMMARY
            echo "|------|------|---------|---------|" >> $GITHUB_STEP_SUMMARY
            while IFS= read -r line; do
              if [[ $line =~ ^(.+):([0-9]+):([0-9]+):(.*)$ ]]; then
                file=${BASH_REMATCH[1]}
                line_num=${BASH_REMATCH[2]}
                severity=${BASH_REMATCH[3]}
                message=${BASH_REMATCH[4]}
                echo "| $file | $line_num | $severity | $message |" >> $GITHUB_STEP_SUMMARY
              fi
            done < clang-tidy-report.txt
          else
            echo "No clang-tidy issues found." >> $GITHUB_STEP_SUMMARY
          fi

  cppcheck:
    name: C/C++ Security Scan & Code Quality (cppcheck)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install cppcheck
        run: sudo apt-get update && sudo apt-get install -y cppcheck

      - name: Run cppcheck
        run: |
          cppcheck --enable=all --inconclusive --template='{file}:{line}:{severity}:{id}:{message}' . 2> cppcheck-report.txt || true

      - name: Summarize cppcheck findings
        if: always()
        run: |
          echo "## cppcheck Security Findings" >> $GITHUB_STEP_SUMMARY
          if [ ! -f cppcheck-report.txt ]; then
            echo "Report missing." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          if [ ! -s cppcheck-report.txt ]; then
            echo "No issues reported." >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

            echo "| File | Line | Severity | ID | Message |" >> $GITHUB_STEP_SUMMARY
            echo "|------|------|----------|----|---------|" >> $GITHUB_STEP_SUMMARY
            awk -F ':' '{printf "| %s | %s | %s | %s | %s |\n", $1, $2, $3, $4, substr($0, index($0, $5))}' cppcheck-report.txt >> $GITHUB_STEP_SUMMARY
